version: '3.8'

services:
  # =========================
  # WireGuard config setup (runs once, generates keys into ./wg/keys)
  # =========================
  wg-setup:
    image: alpine:latest
    container_name: view-guard-wg-setup
    volumes:
      - ./wg:/wg
    entrypoint: [ "/bin/sh", "-c" ]
    command: |
      set -eu
      apk add --no-cache wireguard-tools bash
      echo "[wg-setup] Running generate-keys.sh..."
      bash /wg/generate-keys.sh
      echo "[wg-setup] Done generating keys"
  # =========================
  # Camera / RTSP simulator (commented out - not needed for WireGuard testing)
  # =========================
  # rtsp-simulator:
  #   image: aler9/rtsp-simple-server:latest
  #   container_name: view-guard-rtsp-simulator
  #   ports:
  #     - "8554:8554"
  #     - "1935:1935"
  #   volumes:
  #     - ./rtsp-test:/rtsp-test
  #   command:
  #     - rtsp-simple-server
  #     - /rtsp-test/config.yaml
  #   networks:
  #     - view-guard-edge
  #
  # rtsp-test-stream:
  #   image: michaelbach/rtsp-test-pattern:latest
  #   container_name: view-guard-rtsp-test-stream
  #   depends_on:
  #     - rtsp-simulator
  #   environment:
  #     - RTSP_URL=rtsp://rtsp-simulator:8554/test
  #   networks:
  #     - view-guard-edge

  # =========================
  # Edge side
  # =========================
  edge-ai-service:
    build:
      context: ../../edge/ai-service
      dockerfile: Dockerfile
    container_name: view-guard-edge-ai
    ports:
      - "8180:8080"
    environment:
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - API_HOST=0.0.0.0
      - API_PORT=8080
      - AI_MODEL_NAME=yolov8n
      - AI_MODEL_DIR=/app/models
      - AI_MODEL_FORMAT=openvino
      - AI_DEVICE=CPU
    volumes:
      - ai-models:/app/models
      - ai-data:/app/data
    networks:
      - view-guard-edge
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  edge-orchestrator:
    build:
      context: ../.. # Build from repo root to include crypto/go
      dockerfile: edge/orchestrator/Dockerfile
    container_name: view-guard-edge-orchestrator
    depends_on:
      wg-setup:
        condition: service_completed_successfully
      edge-ai-service:
        condition: service_healthy
    ports:
      - "8181:8081" # Web UI port
    environment:
      - EDGE_AI_SERVICE_URL=http://edge-ai-service:8080
      - EDGE_DATA_DIR=/app/data
      - EDGE_STORAGE_CLIPS_DIR=/app/data/clips
      - EDGE_STORAGE_SNAPSHOTS_DIR=/app/data/snapshots
      - EDGE_WIREGUARD_ENABLED=true
      - EDGE_WIREGUARD_KVM_ENDPOINT=user-vm-api
      - EDGE_TELEMETRY_ENABLED=true
      - EDGE_WEB_ENABLED=true
      - EDGE_WEB_HOST=0.0.0.0
      - EDGE_WEB_PORT=8081
      - LOG_LEVEL=info
      - LOG_FORMAT=text
    volumes:
      - edge-data:/app/data
      - ./config.docker.yaml:/app/config/config.yaml:ro
      - ./wg/config/edge-wg0.conf:/etc/wireguard/wg0.conf:ro
      - /dev:/dev # USB camera devices
    devices:
      - /dev/video2:/dev/video2
      - /dev/video3:/dev/video3
      - /dev/media1:/dev/media1
    privileged: true # Required for USB camera access and V4L2
    networks:
      - view-guard-edge
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =========================
  # User VM side
  # =========================
  user-vm-api:
    build:
      context: ../.. # Build from repo root to include proto/go
      dockerfile: user-vm-api/Dockerfile
    container_name: view-guard-user-vm-api
    depends_on:
      wg-setup:
        condition: service_completed_successfully
      minio:
        condition: service_healthy
      python-ai-service:
        condition: service_started
    ports:
      - "8280:8080" # Stream relay / API Gateway port
      - "51820:51820/udp" # WireGuard server port
      - "9090:9090" # gRPC port (if exposed separately)
    environment:
      - USER_VM_API_DATA_DIR=/app/data
      - USER_VM_API_WIREGUARD_ENABLED=true
      - USER_VM_API_WIREGUARD_INTERFACE=wg0
      - USER_VM_API_WIREGUARD_LISTEN_PORT=51820
      - USER_VM_API_EVENT_CACHE_ENABLED=true
      - USER_VM_API_EVENT_CACHE_DATABASE_PATH=/app/data/events.db
      - USER_VM_API_STREAM_RELAY_ENABLED=true
      - USER_VM_API_STREAM_RELAY_LISTEN_ADDR=:8080
      - USER_VM_API_STORAGE_SYNC_ENABLED=true
      - USER_VM_API_STORAGE_SYNC_PROVIDER=s3
      - USER_VM_API_STORAGE_SYNC_S3_ENDPOINT=http://minio:9000
      - USER_VM_API_STORAGE_SYNC_S3_BUCKET_PREFIX=camera-
      - USER_VM_API_STORAGE_SYNC_S3_ACCESS_KEY=minioadmin
      - USER_VM_API_STORAGE_SYNC_S3_SECRET_KEY=minioadmin
      - USER_VM_API_STORAGE_SYNC_S3_REGION=us-east-1
      - USER_VM_API_STORAGE_SYNC_S3_USE_SSL=false
      - USER_VM_API_PYTHON_AI_SERVICE_URL=http://python-ai-service:8000
      - LOG_LEVEL=info
      - LOG_FORMAT=text
    volumes:
      - user-vm-data:/app/data
      - user-vm-datasets:/app/data/datasets
      - user-vm-models:/app/data/models
      - ./user-vm-config.yaml:/app/config/config.yaml:ro
      - ./wg/config/server-wg0.conf:/etc/wireguard/wg0.conf:ro
    networks:
      - view-guard-edge
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1

  python-ai-service:
    build:
      context: ../..
      dockerfile: user-vm-api/training-service/Dockerfile
    container_name: view-guard-python-ai-service
    ports:
      - "8000:8000"
    environment:
      - PYTHON_AI_SERVICE_HOST=0.0.0.0
      - PYTHON_AI_SERVICE_PORT=8000
      - DATASETS_DIR=/app/data/datasets
      - MODELS_DIR=/app/data/models
      - LOG_LEVEL=INFO
    volumes:
      - user-vm-datasets:/app/data/datasets
      - user-vm-models:/app/data/models
    networks:
      - view-guard-edge
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  minio:
    image: minio/minio:latest
    container_name: view-guard-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio-data:/data
    networks:
      - view-guard-edge
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  view-guard-edge:
    driver: bridge
    name: view-guard-edge

volumes:
  edge-data:
  ai-models:
  ai-data:
  user-vm-data:
  user-vm-datasets:
  user-vm-models:
  minio-data:


