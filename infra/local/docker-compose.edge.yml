version: '3.8'

services:
  # Edge AI Service (Python)
  edge-ai-service:
    build:
      context: ../../edge/ai-service
      dockerfile: Dockerfile
    container_name: view-guard-edge-ai
    ports:
      - "8180:8080"
    environment:
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - API_HOST=0.0.0.0
      - API_PORT=8080
      - AI_MODEL_NAME=yolov8n
      - AI_MODEL_DIR=/app/models
      - AI_MODEL_FORMAT=openvino
      - AI_DEVICE=CPU
    volumes:
      - ai-models:/app/models  # Persist models across container restarts
      - ai-data:/app/data
    networks:
      - view-guard-edge
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Give time for model download on first start

  # Edge Orchestrator (Go)
  edge-orchestrator:
    build:
      context: ../..  # Build from repo root to include crypto/go
      dockerfile: edge/orchestrator/Dockerfile
    container_name: view-guard-edge-orchestrator
    depends_on:
      edge-ai-service:
        condition: service_healthy
    ports:
      - "8181:8081"  # Web UI port
    environment:
      - EDGE_AI_SERVICE_URL=http://edge-ai-service:8080
      - EDGE_DATA_DIR=/app/data
      - EDGE_STORAGE_CLIPS_DIR=/app/data/clips
      - EDGE_STORAGE_SNAPSHOTS_DIR=/app/data/snapshots
      - EDGE_WIREGUARD_ENABLED=false
      - EDGE_TELEMETRY_ENABLED=true
      - EDGE_WEB_ENABLED=true
      - EDGE_WEB_HOST=0.0.0.0
      - EDGE_WEB_PORT=8081
      - LOG_LEVEL=info
      - LOG_FORMAT=text
    volumes:
      - edge-data:/app/data
      - ./config.docker.yaml:/app/config/config.yaml:ro
      # Mount USB camera devices
      - /dev:/dev
    devices:
      # Pass 5MP USB Camera devices (usb-0000:00:14.0-5)
      - /dev/video2:/dev/video2
      - /dev/video3:/dev/video3
      - /dev/media1:/dev/media1
    privileged: true  # Required for USB camera access and V4L2
    networks:
      - view-guard-edge
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  edge-data:
    driver: local
  ai-models:
    driver: local
  ai-data:
    driver: local

networks:
  view-guard-edge:
    driver: bridge
    name: view-guard-edge  # Named network for cross-compose communication

